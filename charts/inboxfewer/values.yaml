replicaCount: 1

image:
  repository: ghcr.io/teemow/inboxfewer
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  # Set to false as the app doesn't need Kubernetes API access
  automount: false
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

service:
  type: ClusterIP
  port: 8080
  targetPort: 8080
  annotations: {}

ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: inboxfewer.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: inboxfewer-tls
  #    hosts:
  #      - inboxfewer.local

# Gateway API Configuration
# Gateway API is the successor to Ingress, providing more powerful and expressive routing.
# Both Ingress and Gateway API can be enabled simultaneously for migration scenarios.
gatewayAPI:
  # Enable Gateway API HTTPRoute
  enabled: false

  # HTTPRoute configuration
  httpRoute:
    # Parent gateway references (required when enabled)
    # Example:
    #   parentRefs:
    #     - name: internal
    #       namespace: envoy-gateway-system
    parentRefs: []

    # Hostnames for the route
    # Example:
    #   hostnames:
    #     - inboxfewer.example.com
    hostnames: []

    # Routing rules (optional, defaults to a single PathPrefix "/" rule)
    # If not specified, a default rule matching "/" with PathPrefix is created
    # Example:
    #   rules:
    #     - matches:
    #         - path:
    #             type: PathPrefix
    #             value: /api
    #       timeouts:
    #         request: 30s
    rules: []

    # Additional annotations for the HTTPRoute
    annotations: {}

    # Additional labels for the HTTPRoute
    labels: {}

  # BackendTrafficPolicy for Envoy Gateway (optional)
  # Provides timeout and retry configuration at the backend level
  # This is specific to Envoy Gateway - other implementations may use different CRDs
  backendTrafficPolicy:
    # Enable BackendTrafficPolicy creation
    enabled: false

    # Request timeout (e.g., "300s", "5m")
    # MCP sessions can be long-running, so a longer timeout is recommended
    timeout: "300s"

    # Additional annotations for the BackendTrafficPolicy
    annotations: {}

    # Additional labels for the BackendTrafficPolicy
    labels: {}

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

livenessProbe:
  enabled: true
  httpGet:
    path: /healthz
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /readyz
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

# Pod disruption budget for controlled disruptions
podDisruptionBudget:
  enabled: false
  maxUnavailable: 1

# Additional volumes on the output Deployment definition.
volumes:
  # Cache directory for OAuth tokens and application cache
  # Using emptyDir allows writes with readOnlyRootFilesystem: true
  # Tokens are lost on pod restart, requiring re-authentication
  - name: cache
    emptyDir: {}
# - name: foo
#   secret:
#     secretName: mysecret
#     optional: false

# Additional volumeMounts on the output Deployment definition.
volumeMounts:
  # Mount writable cache directory for OAuth tokens
  - name: cache
    mountPath: /home/inboxfewer/.cache
# - name: foo
#   mountPath: "/etc/foo"
#   readOnly: true

nodeSelector: {}

tolerations: []

affinity: {}

# Application configuration
config:
  # Transport type: stdio or streamable-http
  transport: "streamable-http"
  # HTTP server address
  httpAddr: ":8080"
  # Public base URL for OAuth (required for deployed instances)
  # Example: "https://inboxfewer.example.com"
  # If not set, auto-detected as http://localhost:8080 (development only)
  baseURL: ""
  # Enable write operations (default: false for read-only mode)
  yolo: false
  # Enable debug logging
  debug: false
  # Disable streaming for HTTP transport
  disableStreaming: false

# Google OAuth configuration
google:
  # Google OAuth Client ID for automatic token refresh
  # Set via environment variable or secret
  clientId: ""
  # Google OAuth Client Secret for automatic token refresh
  # Set via environment variable or secret
  clientSecret: ""

# OAuth Security Settings (secure by default)
# Only modify these if you understand the security implications
oauthSecurity:
  # Allow unauthenticated dynamic client registration
  # WARNING: Setting to true weakens security and enables DoS attacks
  # Default: false (requires registration access token)
  allowPublicClientRegistration: false
  
  # Registration access token required for client registration
  # Only used if allowPublicClientRegistration is false
  # Generate a secure random token (e.g., openssl rand -base64 32)
  registrationAccessToken: ""
  
  # AES-256 encryption key for token storage at rest (32 bytes, base64 encoded)
  # REQUIRED for production deployments
  # Generate with: openssl rand -base64 32
  # If not set, tokens are stored unencrypted in memory (development only)
  encryptionKey: ""
  
  # Allow authorization without state parameter
  # WARNING: Setting to true weakens CSRF protection
  # Default: false (state parameter required)
  allowInsecureAuthWithoutState: false
  
  # Maximum number of clients that can be registered per IP address
  # Prevents DoS attacks via mass client registration
  # Default: 10
  maxClientsPerIP: 10

  # Redirect URI Security Configuration (mcp-oauth v0.2.30+)
  # All settings default to secure values. Use disable* to opt-out.
  redirectURISecurity:
    # Disable production mode security validation
    # Production mode enforces: HTTPS required, private IPs blocked, dangerous schemes blocked
    # WARNING: Significantly weakens redirect URI security. Only disable for development.
    # Default: false (production mode is enabled)
    disableProductionMode: false

    # Allow http://localhost and http://127.0.0.1 redirect URIs
    # Required for native apps per RFC 8252 Section 7.3
    # Default: false (operators must explicitly enable for native app support)
    allowLocalhostRedirectURIs: false

    # Allow private IP addresses (10.x, 172.16.x, 192.168.x) in redirect URIs
    # WARNING: Enables SSRF attacks to internal networks if not properly secured.
    # Only enable for internal/VPN deployments where clients use private IPs.
    # Default: false (blocked for security)
    allowPrivateIPRedirectURIs: false

    # Allow link-local addresses (169.254.x.x, fe80::/10) in redirect URIs
    # WARNING: Could enable access to cloud metadata services (169.254.169.254).
    # This is a significant security risk in AWS, GCP, Azure environments.
    # Default: false (blocked for security)
    allowLinkLocalRedirectURIs: false

    # Disable DNS validation of redirect URI hostnames
    # DNS validation checks if hostnames resolve to private/internal IPs.
    # WARNING: Disabling allows potential DNS rebinding attacks.
    # Default: false (DNS validation is enabled)
    disableDNSValidation: false

    # Disable fail-closed DNS validation
    # When strict mode is enabled, DNS resolution failures block client registration.
    # When disabled, DNS failures are logged but registration proceeds (fail-open).
    # WARNING: Disabling allows potential DNS validation bypass via intentional failures.
    # Default: false (strict mode is enabled)
    disableDNSValidationStrict: false

    # Disable redirect URI validation at authorization time
    # By default, redirect URIs are re-validated during authorization requests,
    # not just at registration time. This protects against TOCTOU attacks.
    # WARNING: Disabling allows DNS rebinding attacks between registration and use.
    # Default: false (authorization-time validation is enabled)
    disableAuthorizationTimeValidation: false

  # Trusted Scheme Registration for Cursor/VSCode Compatibility (mcp-oauth v0.2.30+)
  # This feature allows unauthenticated client registration for clients using
  # specific custom URI schemes (e.g., cursor://, vscode://), while requiring
  # registration tokens for all other clients.
  #
  # Security Model:
  # Custom URI schemes can only be intercepted by the application that registered
  # the scheme with the OS. An attacker cannot register a malicious OAuth client
  # with cursor:// because they cannot receive the authorization callback.
  #
  # Example: ["cursor", "vscode", "vscode-insiders", "windsurf"]
  # Default: [] (all registrations require a token)
  trustedPublicRegistrationSchemes: []

  # Disable strict scheme matching for trusted scheme registration
  # When strict matching is enabled (default), ALL redirect URIs in a registration
  # request must use schemes from trustedPublicRegistrationSchemes.
  # When disabled, if ANY redirect URI uses a trusted scheme, registration is allowed.
  # WARNING: Reduces security by allowing untrusted redirect URIs alongside trusted ones.
  # Default: false (strict matching is enabled)
  disableStrictSchemeMatching: false

  # Client ID Metadata Documents (CIMD) - MCP 2025-11-25 (mcp-oauth v0.2.30+)
  # When enabled, clients can use HTTPS URLs as client identifiers (e.g.,
  # https://myapp.example.com/.well-known/oauth-client). The authorization server
  # fetches client metadata from that URL, enabling decentralized client registration.
  #
  # Security: CIMD requires the server to make outbound HTTPS requests. The mcp-oauth
  # library implements comprehensive SSRF protection (blocks private IPs, DNS rebinding).
  #
  # Default: true (enabled per MCP 2025-11-25 specification)
  enableCIMD: true

  # CIMD (Client ID Metadata Documents) Security Configuration (mcp-oauth v0.2.33+)
  cimd:
    # Allow CIMD metadata URLs that resolve to private IP addresses
    # (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 per RFC 1918).
    # This also allows loopback addresses (127.0.0.0/8, ::1) and link-local addresses.
    #
    # WARNING: Reduces SSRF protection. Only enable for internal/VPN deployments where
    # MCP servers legitimately communicate over private networks.
    #
    # Use cases:
    #   - Home lab deployments with MCP servers on the same internal network
    #   - Air-gapped environments
    #   - Internal enterprise networks with MCP aggregators
    #
    # Security: When enabled, the server will fetch client metadata from URLs that
    # resolve to private IPs. PKCE and other OAuth security measures still apply.
    #
    # Default: false (blocked for security - SSRF protection enabled)
    allowPrivateIPs: false

  # SSO Token Forwarding (mcp-oauth v0.2.38+)
  # Accept tokens from trusted upstream aggregators for Single Sign-On (SSO).
  # This enables scenarios where an MCP aggregator (like muster) forwards user
  # tokens to downstream MCP servers without requiring separate authentication.
  #
  # Security Model:
  #   - Tokens MUST still be from the configured issuer (Google/Dex)
  #   - Tokens MUST be cryptographically signed by the issuer
  #   - Token scopes are preserved and enforced (no scope escalation)
  #   - Only the audience claim is relaxed to accept listed client IDs
  #
  # Monitoring:
  #   - Metric: oauth_cross_client_token_total{result="accepted|rejected"}
  #   - Audit: EventCrossClientTokenAccepted logged with audience and user
  #   - Warning logged at startup when SSO is enabled
  #
  # Example: Accept tokens from muster and another aggregator
  #   trustedAudiences:
  #     - "muster-client"
  #     - "my-aggregator-client"
  #
  # Default: [] (only accept tokens issued directly to this server's client_id)
  trustedAudiences: []

  # Token storage configuration (mcp-oauth v0.2.30+)
  # In-memory storage is default but NOT recommended for production
  # Use Valkey for production deployments to enable:
  #   - Session persistence across pod restarts
  #   - Horizontal scaling with shared session state
  #   - Rolling updates without user session loss
  #
  # PRODUCTION REQUIREMENTS:
  #   1. Use Valkey (not memory) storage for production
  #   2. Enable TLS for Valkey connections (tls.enabled: true)
  #   3. Always use authentication (existingSecret is mandatory)
  #   4. Set up token encryption (see oauthSecurity.encryptionKeySecret)
  #   5. Configure network policies to restrict Valkey access
  storage:
    # Storage backend type: "memory" or "valkey"
    # Default: "memory" (NOT recommended for production)
    type: "memory"

    # Valkey (Redis-compatible) storage configuration
    # Required when storage.type is "valkey"
    valkey:
      # Valkey server URL (e.g., "valkey.namespace.svc:6379")
      # Required when using Valkey storage
      url: ""

      # Enable TLS for Valkey connections
      # MANDATORY for production - tokens contain sensitive OAuth credentials
      tls:
        enabled: false

        # Custom CA certificate for Valkey TLS (optional)
        # Use when Valkey uses certificates signed by a private CA
        # Reference a secret containing the CA certificate
        caSecretName: ""
        # Key in the secret containing the CA certificate (default: ca.crt)
        caSecretKey: "ca.crt"

      # Key prefix for all Valkey keys
      # Useful for multi-tenant deployments sharing a Valkey instance
      keyPrefix: "mcp:"

      # Valkey database number (0-15)
      db: 0

      # Use an existing secret for Valkey password
      # MANDATORY for production - unauthenticated Valkey is a security risk
      # The secret should contain key: valkey-password
      existingSecret: ""

      # Key in the secret containing the Valkey password
      secretKeyPassword: "valkey-password"

# TLS/HTTPS Configuration
# Native HTTPS support without reverse proxy
tls:
  # Enable native TLS/HTTPS
  enabled: false

  # TLS certificate and key can be provided via:
  # 1. Existing secret reference (recommended for production)
  # 2. Inline values (not recommended, use secrets instead)

  # Existing secret containing TLS certificate and key
  # The secret should contain keys: tls.crt, tls.key
  existingSecret: ""

  # Path where TLS files will be mounted (if using existingSecret)
  # Default: /etc/tls
  mountPath: "/etc/tls"

# OAuth Interstitial Page Branding
# Customize the success page shown after OAuth authentication for custom URL schemes
# (cursor://, vscode://, etc.). If not set, uses the mcp-oauth default styling.
interstitial:
  # Logo URL displayed on the success page (must be HTTPS)
  # Example: "https://raw.githubusercontent.com/teemow/inboxfewer/main/assets/logo/logo-512.png"
  logoURL: ""
  # Alt text for the logo image (for accessibility)
  # Example: "inboxfewer logo"
  logoAlt: ""
  # Title displayed on the success page
  # Example: "Connected to Inboxfewer"
  title: ""
  # Message shown below the title
  # Use {{.AppName}} placeholder for the app name
  # Example: "You have been authenticated with {{.AppName}}. You can now close this window."
  message: ""
  # Button text for manual redirect
  # Use {{.AppName}} placeholder for the app name
  # Example: "Return to {{.AppName}}"
  buttonText: ""
  # Primary/accent color for buttons (CSS color value)
  # Example: "#667eea"
  primaryColor: ""
  # Background gradient CSS value
  # Example: "linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%)"
  backgroundGradient: ""

# Existing secret containing Google OAuth credentials
# Keys should be: google-client-id, google-client-secret
# Optionally: oauth-registration-token, oauth-encryption-key
existingSecret: ""

# GitHub configuration (required for cleanup command)
github:
  # GitHub username
  user: ""
  # GitHub token
  token: ""

# Existing secret containing GitHub credentials
# Keys should be: github-user, github-token
githubSecret: ""

# Network policies for defense-in-depth security
networkPolicy:
  # Enable NetworkPolicy for controlling pod network access
  enabled: false
  policyTypes:
    - Ingress
    - Egress
  # Ingress rules - who can connect to this pod
  ingress:
    - from:
      # Allow ingress from pods with specific labels
      - podSelector:
          matchLabels:
            app: allowed-client
      # Allow ingress from specific namespaces
      # - namespaceSelector:
      #     matchLabels:
      #       name: allowed-namespace
      ports:
      - protocol: TCP
        port: 8080
  # Egress rules - where this pod can connect to
  egress:
    # Allow HTTPS to external APIs (Google, GitHub)
    - to:
      - namespaceSelector: {}
      ports:
      - protocol: TCP
        port: 443
    # Allow DNS queries
    - to:
      - namespaceSelector:
          matchLabels:
            name: kube-system
      - podSelector:
          matchLabels:
            k8s-app: kube-dns
      ports:
      - protocol: UDP
        port: 53

# Cilium Network Policy configuration
# More advanced network policy for Cilium users
ciliumNetworkPolicy:
  # Enable CiliumNetworkPolicy for enhanced network control
  enabled: false
  # Additional labels to add to the CiliumNetworkPolicy
  labels: {}
  # Additional annotations to add to the CiliumNetworkPolicy
  annotations: {}

# Metrics server configuration
# Prometheus metrics are served on a dedicated port (default: 9090) that is separate
# from the main application port (8080). This follows security best practices by
# isolating operational metrics from public-facing traffic.
#
# SECURITY WARNING: The metrics endpoint should NEVER be exposed externally.
#   - Metrics may contain operational data useful for reconnaissance
#   - Keep service type as ClusterIP (never LoadBalancer or NodePort)
#   - Do NOT create an Ingress for the metrics service
#   - Only allow in-cluster Prometheus to scrape metrics
#   - The CiliumNetworkPolicy/NetworkPolicy templates restrict metrics access to cluster-internal traffic
metrics:
  # Enable the metrics server
  enabled: true

  # Port for the metrics server
  port: 9090

  # Service configuration for metrics
  service:
    # Service type for metrics
    # SECURITY: Keep as ClusterIP - never expose metrics externally
    type: ClusterIP
    # Service annotations (e.g., for service discovery)
    annotations: {}

# Instrumentation configuration
# OpenTelemetry-based observability for metrics and tracing
instrumentation:
  # Enable/disable instrumentation
  enabled: true

  # Metrics exporter type: prometheus, otlp, stdout
  metricsExporter: prometheus

  # Tracing exporter type: otlp, stdout, none
  tracingExporter: none

  # OTLP endpoint for traces/metrics (required when using otlp exporter)
  # Example: "otel-collector.observability:4318"
  otlpEndpoint: ""

  # Use insecure connection for OTLP
  # SECURITY WARNING: NEVER enable in production!
  #   - Traces contain sensitive metadata (user IDs, request details, tool invocations)
  #   - Metrics may reveal operational patterns useful for reconnaissance
  #   - Only acceptable for localhost development (127.0.0.1, localhost)
  #   - The application logs a SECURITY WARNING if enabled for non-localhost endpoints
  otlpInsecure: false

  # Trace sampling rate (0.0 to 1.0, default: 0.1 = 10%)
  traceSamplingRate: "0.1"

  # Include detailed/high-cardinality labels in metrics
  # WARNING: Can cause cardinality explosion in production
  # This may include user-identifying information in metric labels
  detailedLabels: false

  # Audit logging configuration
  # Audit logs track all MCP tool invocations for security and compliance purposes.
  auditLogging:
    # Enable/disable audit logging
    enabled: true

    # Include full email addresses (PII) in audit logs
    # SECURITY: When enabled, audit logs contain PII and MUST be:
    #   - Stored securely with appropriate access controls
    #   - Routed to a separate log destination if possible
    #   - Retained according to your data retention policy
    # When disabled (default), only anonymized domain-based identifiers are logged.
    # Tip: Use log filtering/routing rules to separate audit events by the
    # "tool_executed" and "tool_audit" log messages.
    includePII: false

# ServiceMonitor for Prometheus Operator

serviceMonitor:
  # Enable ServiceMonitor creation (requires Prometheus Operator CRDs)
  enabled: false
  # Additional labels for the ServiceMonitor (e.g., for Prometheus selection)
  labels: {}
  # Additional annotations for the ServiceMonitor
  annotations: {}
  # Scrape interval (default: Prometheus default)
  interval: ""
  # Scrape timeout (default: Prometheus default)
  scrapeTimeout: ""
  # Relabelings for the ServiceMonitor
  relabelings: []
  # Metric relabelings for the ServiceMonitor
  metricRelabelings: []

# Grafana Dashboard ConfigMaps
# Creates ConfigMaps containing Grafana dashboards that can be automatically
# imported by Grafana's sidecar (e.g., kube-prometheus-stack)
grafanaDashboards:
  # Enable dashboard ConfigMap creation
  enabled: false

  # Namespace where Grafana is installed (for dashboard ConfigMaps)
  # If not set, dashboards are created in the release namespace
  # Note: Grafana sidecar must be configured to watch this namespace
  # RBAC: When deploying to a different namespace, ensure the Helm release
  # ServiceAccount has permissions to create ConfigMaps in the target namespace,
  # or use a ClusterRole with cross-namespace ConfigMap creation rights.
  namespace: ""

  # Labels to add to dashboard ConfigMaps for Grafana sidecar discovery
  # The default label "grafana_dashboard: '1'" is used by kube-prometheus-stack
  labels:
    grafana_dashboard: "1"

  # Additional annotations for dashboard ConfigMaps
  annotations: {}

  # Folder in Grafana where dashboards will be placed
  # Requires Grafana sidecar v1.3.0+ with folderAnnotation enabled
  folder: "Inboxfewer"

  # Enable individual dashboards
  dashboards:
    # Administrator dashboard for Kubernetes operators
    # Monitors service health, performance, and resource utilization
    administrator:
      enabled: true

    # Security Operations dashboard for incident investigation
    # Provides audit trails, anomaly detection, and compliance reporting
    # Requires Loki for log panels
    security:
      enabled: true

    # End-User dashboard for AI agent activity visibility
    # Helps users understand how AI agents use MCP tools on their behalf
    endUser:
      enabled: true

# Prometheus Alerting Rules
# Creates a PrometheusRule resource for alerting on inboxfewer metrics
# Requires prometheus-operator or kube-prometheus-stack
prometheusRule:
  # Enable PrometheusRule creation
  enabled: false

  # Namespace for the PrometheusRule (defaults to release namespace)
  namespace: ""

  # Labels to add to the PrometheusRule for Prometheus discovery
  # Match these to your Prometheus operator's ruleSelector
  labels: {}
    # prometheus: kube-prometheus
    # release: prometheus

  # Additional annotations
  annotations: {}

  # Individual alert rules configuration
  rules:
    # HTTP Error Rate: Alert when 5xx errors exceed threshold
    httpErrorRate:
      enabled: true
      # Error rate percentage threshold
      threshold: 5
      # How long the condition must be true before firing
      for: 5m
      # Alert severity (critical, warning, info)
      severity: warning
      # Additional labels for the alert
      labels: {}
      # Runbook URL for incident response
      runbookUrl: ""

    # High Latency: Alert when P95 latency exceeds threshold
    highLatency:
      enabled: true
      # P95 latency threshold in seconds
      threshold: 2
      for: 5m
      severity: warning
      labels: {}
      runbookUrl: ""

    # OAuth Failures: Alert on authentication failures
    oauthFailures:
      enabled: true
      # Failures per minute threshold
      threshold: 10
      for: 5m
      severity: warning
      labels: {}
      runbookUrl: ""

    # Pod Restarts: Alert on container restarts
    podRestarts:
      enabled: true
      # Restart count threshold per hour
      threshold: 3
      for: 5m
      severity: warning
      labels: {}
      runbookUrl: ""

    # Google API Errors: Alert on API failures
    googleAPIErrors:
      enabled: true
      # Error rate percentage threshold
      threshold: 10
      for: 5m
      severity: warning
      labels: {}
      runbookUrl: ""

    # MCP Tool Errors: Alert on tool invocation failures
    toolErrors:
      enabled: true
      # Error rate percentage threshold
      threshold: 10
      for: 5m
      severity: warning
      labels: {}
      runbookUrl: ""
