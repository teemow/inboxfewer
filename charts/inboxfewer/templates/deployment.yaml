apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "inboxfewer.fullname" . }}
  labels:
    {{- include "inboxfewer.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      {{- include "inboxfewer.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "inboxfewer.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "inboxfewer.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: {{ .Chart.Name }}
        securityContext:
          {{- toYaml .Values.securityContext | nindent 12 }}
        image: {{ include "inboxfewer.image" . }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        args:
          - serve
          - --transport
          - {{ .Values.config.transport }}
          - --http-addr
          - {{ .Values.config.httpAddr }}
          {{- if .Values.config.yolo }}
          - --yolo
          {{- end }}
          {{- if .Values.config.debug }}
          - --debug
          {{- end }}
          {{- if .Values.config.disableStreaming }}
          - --disable-streaming
          {{- end }}
        {{- if or .Values.google.clientId .Values.google.clientSecret .Values.existingSecret .Values.config.baseURL .Values.oauthSecurity.allowPublicClientRegistration .Values.oauthSecurity.registrationAccessToken .Values.oauthSecurity.allowInsecureAuthWithoutState }}
        env:
          {{- if .Values.config.baseURL }}
          - name: MCP_BASE_URL
            value: {{ .Values.config.baseURL | quote }}
          {{- end }}
          {{- if or .Values.google.clientId .Values.existingSecret }}
          - name: GOOGLE_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: {{ .Values.existingSecret | default (include "inboxfewer.fullname" .) }}
                key: google-client-id
          {{- end }}
          {{- if or .Values.google.clientSecret .Values.existingSecret }}
          - name: GOOGLE_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: {{ .Values.existingSecret | default (include "inboxfewer.fullname" .) }}
                key: google-client-secret
          {{- end }}
          {{- if .Values.oauthSecurity.allowPublicClientRegistration }}
          - name: MCP_OAUTH_ALLOW_PUBLIC_REGISTRATION
            value: "true"
          {{- end }}
          {{- if .Values.oauthSecurity.registrationAccessToken }}
          - name: MCP_OAUTH_REGISTRATION_TOKEN
            valueFrom:
              secretKeyRef:
                name: {{ .Values.existingSecret | default (include "inboxfewer.fullname" .) }}
                key: oauth-registration-token
                {{- if .Values.oauthSecurity.allowPublicClientRegistration }}
                optional: true
                {{- else }}
                optional: false
                {{- end }}
          {{- end }}
          {{- if .Values.oauthSecurity.encryptionKey }}
          - name: MCP_OAUTH_ENCRYPTION_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Values.existingSecret | default (include "inboxfewer.fullname" .) }}
                key: oauth-encryption-key
                optional: false
          {{- end }}
          {{- if .Values.oauthSecurity.allowInsecureAuthWithoutState }}
          - name: MCP_OAUTH_ALLOW_NO_STATE
            value: "true"
          {{- end }}
          {{- if and .Values.oauthSecurity.maxClientsPerIP (ne (.Values.oauthSecurity.maxClientsPerIP | int) 10) }}
          - name: MCP_OAUTH_MAX_CLIENTS_PER_IP
            value: {{ .Values.oauthSecurity.maxClientsPerIP | quote }}
          {{- end }}
          {{- if .Values.interstitial }}
          {{- if .Values.interstitial.logoURL }}
          - name: MCP_INTERSTITIAL_LOGO_URL
            value: {{ .Values.interstitial.logoURL | quote }}
          {{- end }}
          {{- if .Values.interstitial.logoAlt }}
          - name: MCP_INTERSTITIAL_LOGO_ALT
            value: {{ .Values.interstitial.logoAlt | quote }}
          {{- end }}
          {{- if .Values.interstitial.title }}
          - name: MCP_INTERSTITIAL_TITLE
            value: {{ .Values.interstitial.title | quote }}
          {{- end }}
          {{- if .Values.interstitial.message }}
          - name: MCP_INTERSTITIAL_MESSAGE
            value: {{ .Values.interstitial.message | quote }}
          {{- end }}
          {{- if .Values.interstitial.buttonText }}
          - name: MCP_INTERSTITIAL_BUTTON_TEXT
            value: {{ .Values.interstitial.buttonText | quote }}
          {{- end }}
          {{- if .Values.interstitial.primaryColor }}
          - name: MCP_INTERSTITIAL_PRIMARY_COLOR
            value: {{ .Values.interstitial.primaryColor | quote }}
          {{- end }}
          {{- if .Values.interstitial.backgroundGradient }}
          - name: MCP_INTERSTITIAL_BACKGROUND_GRADIENT
            value: {{ .Values.interstitial.backgroundGradient | quote }}
          {{- end }}
          {{- end }}
          {{- /* Redirect URI Security Settings (mcp-oauth v0.2.30+) */ -}}
          {{- if .Values.oauthSecurity.redirectURISecurity }}
          {{- if .Values.oauthSecurity.redirectURISecurity.disableProductionMode }}
          - name: MCP_OAUTH_DISABLE_PRODUCTION_MODE
            value: "true"
          {{- end }}
          {{- if .Values.oauthSecurity.redirectURISecurity.allowLocalhostRedirectURIs }}
          - name: MCP_OAUTH_ALLOW_LOCALHOST_REDIRECT_URIS
            value: "true"
          {{- end }}
          {{- if .Values.oauthSecurity.redirectURISecurity.allowPrivateIPRedirectURIs }}
          - name: MCP_OAUTH_ALLOW_PRIVATE_IP_REDIRECT_URIS
            value: "true"
          {{- end }}
          {{- if .Values.oauthSecurity.redirectURISecurity.allowLinkLocalRedirectURIs }}
          - name: MCP_OAUTH_ALLOW_LINK_LOCAL_REDIRECT_URIS
            value: "true"
          {{- end }}
          {{- if .Values.oauthSecurity.redirectURISecurity.disableDNSValidation }}
          - name: MCP_OAUTH_DISABLE_DNS_VALIDATION
            value: "true"
          {{- end }}
          {{- if .Values.oauthSecurity.redirectURISecurity.disableDNSValidationStrict }}
          - name: MCP_OAUTH_DISABLE_DNS_VALIDATION_STRICT
            value: "true"
          {{- end }}
          {{- if .Values.oauthSecurity.redirectURISecurity.disableAuthorizationTimeValidation }}
          - name: MCP_OAUTH_DISABLE_AUTHORIZATION_TIME_VALIDATION
            value: "true"
          {{- end }}
          {{- end }}
          {{- /* Trusted Scheme Registration (mcp-oauth v0.2.30+) */ -}}
          {{- if .Values.oauthSecurity.trustedPublicRegistrationSchemes }}
          - name: MCP_OAUTH_TRUSTED_SCHEMES
            value: {{ .Values.oauthSecurity.trustedPublicRegistrationSchemes | join "," | quote }}
          {{- end }}
          {{- if .Values.oauthSecurity.disableStrictSchemeMatching }}
          - name: MCP_OAUTH_DISABLE_STRICT_SCHEME_MATCHING
            value: "true"
          {{- end }}
          {{- /* CIMD (Client ID Metadata Documents) per MCP 2025-11-25 (mcp-oauth v0.2.30+) */ -}}
          {{- if hasKey .Values.oauthSecurity "enableCIMD" }}
          - name: MCP_OAUTH_ENABLE_CIMD
            value: {{ .Values.oauthSecurity.enableCIMD | quote }}
          {{- end }}
          {{- /* CIMD Security (mcp-oauth v0.2.33+) */ -}}
          {{- if and .Values.oauthSecurity.cimd .Values.oauthSecurity.cimd.allowPrivateIPs }}
          - name: CIMD_ALLOW_PRIVATE_IPS
            value: "true"
          {{- end }}
          {{- /* SSO Token Forwarding (mcp-oauth v0.2.38+) */ -}}
          {{- if .Values.oauthSecurity.trustedAudiences }}
          - name: OAUTH_TRUSTED_AUDIENCES
            value: {{ .Values.oauthSecurity.trustedAudiences | join "," | quote }}
          {{- end }}
          {{- /* Valkey storage configuration (mcp-oauth v0.2.30+) */ -}}
          {{- if eq ((.Values.oauthSecurity.storage).type | default "memory") "valkey" }}
          - name: OAUTH_STORAGE_TYPE
            value: "valkey"
          - name: VALKEY_URL
            value: {{ required "oauthSecurity.storage.valkey.url is required when using Valkey storage" .Values.oauthSecurity.storage.valkey.url | quote }}
          {{- if .Values.oauthSecurity.storage.valkey.tls.enabled }}
          - name: VALKEY_TLS_ENABLED
            value: "true"
          {{- if .Values.oauthSecurity.storage.valkey.tls.caSecretName }}
          - name: VALKEY_TLS_CA_FILE
            value: "/etc/valkey-tls/{{ .Values.oauthSecurity.storage.valkey.tls.caSecretKey | default "ca.crt" }}"
          {{- end }}
          {{- end }}
          {{- if .Values.oauthSecurity.storage.valkey.keyPrefix }}
          - name: VALKEY_KEY_PREFIX
            value: {{ .Values.oauthSecurity.storage.valkey.keyPrefix | quote }}
          {{- end }}
          {{- if .Values.oauthSecurity.storage.valkey.db }}
          - name: VALKEY_DB
            value: {{ .Values.oauthSecurity.storage.valkey.db | quote }}
          {{- end }}
          {{- if or .Values.oauthSecurity.storage.valkey.existingSecret .Values.existingSecret }}
          - name: VALKEY_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ .Values.oauthSecurity.storage.valkey.existingSecret | default .Values.existingSecret | default (include "inboxfewer.fullname" .) }}
                key: {{ .Values.oauthSecurity.storage.valkey.secretKeyPassword | default "valkey-password" }}
                optional: true
          {{- end }}
          {{- end }}
          {{- /* TLS configuration */ -}}
          {{- if .Values.tls.enabled }}
          - name: TLS_CERT_FILE
            value: "{{ .Values.tls.mountPath }}/tls.crt"
          - name: TLS_KEY_FILE
            value: "{{ .Values.tls.mountPath }}/tls.key"
          {{- end }}
          {{- /* Metrics server configuration */ -}}
          {{- if .Values.metrics.enabled }}
          - name: METRICS_ENABLED
            value: "true"
          - name: METRICS_ADDR
            value: ":{{ .Values.metrics.port }}"
          {{- end }}
          {{- /* Instrumentation configuration */ -}}
          {{- if .Values.instrumentation }}
          {{- if hasKey .Values.instrumentation "enabled" }}
          - name: INSTRUMENTATION_ENABLED
            value: {{ .Values.instrumentation.enabled | quote }}
          {{- end }}
          {{- if .Values.instrumentation.metricsExporter }}
          - name: METRICS_EXPORTER
            value: {{ .Values.instrumentation.metricsExporter | quote }}
          {{- end }}
          {{- if .Values.instrumentation.tracingExporter }}
          - name: TRACING_EXPORTER
            value: {{ .Values.instrumentation.tracingExporter | quote }}
          {{- end }}
          {{- if .Values.instrumentation.otlpEndpoint }}
          - name: OTEL_EXPORTER_OTLP_ENDPOINT
            value: {{ .Values.instrumentation.otlpEndpoint | quote }}
          {{- end }}
          {{- if .Values.instrumentation.otlpInsecure }}
          - name: OTEL_EXPORTER_OTLP_INSECURE
            value: "true"
          {{- end }}
          {{- if .Values.instrumentation.traceSamplingRate }}
          - name: OTEL_TRACES_SAMPLER_ARG
            value: {{ .Values.instrumentation.traceSamplingRate | quote }}
          {{- end }}
          {{- if .Values.instrumentation.detailedLabels }}
          - name: METRICS_DETAILED_LABELS
            value: "true"
          {{- end }}
          {{- if .Values.instrumentation.auditLogging }}
          {{- if hasKey .Values.instrumentation.auditLogging "enabled" }}
          - name: AUDIT_LOGGING_ENABLED
            value: {{ .Values.instrumentation.auditLogging.enabled | quote }}
          {{- end }}
          {{- if .Values.instrumentation.auditLogging.includePII }}
          - name: AUDIT_LOGGING_INCLUDE_PII
            value: "true"
          {{- end }}
          {{- end }}
          {{- end }}
        {{- end }}
        ports:
          - name: http
            containerPort: {{ .Values.service.targetPort }}
            protocol: TCP
          {{- if .Values.metrics.enabled }}
          - name: metrics
            containerPort: {{ .Values.metrics.port }}
            protocol: TCP
          {{- end }}
        {{- if .Values.livenessProbe.enabled }}
        livenessProbe:
          {{- if .Values.livenessProbe.httpGet }}
          httpGet:
            path: {{ .Values.livenessProbe.httpGet.path }}
            port: {{ .Values.livenessProbe.httpGet.port }}
          {{- else if .Values.livenessProbe.tcpSocket }}
          tcpSocket:
            {{- toYaml .Values.livenessProbe.tcpSocket | nindent 12 }}
          {{- end }}
          initialDelaySeconds: {{ .Values.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.livenessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.livenessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.livenessProbe.failureThreshold }}
        {{- end }}
        {{- if .Values.readinessProbe.enabled }}
        readinessProbe:
          {{- if .Values.readinessProbe.httpGet }}
          httpGet:
            path: {{ .Values.readinessProbe.httpGet.path }}
            port: {{ .Values.readinessProbe.httpGet.port }}
          {{- else if .Values.readinessProbe.tcpSocket }}
          tcpSocket:
            {{- toYaml .Values.readinessProbe.tcpSocket | nindent 12 }}
          {{- end }}
          initialDelaySeconds: {{ .Values.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.readinessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.readinessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.readinessProbe.failureThreshold }}
        {{- end }}
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
        volumeMounts:
          {{- with .Values.volumeMounts }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
          {{- if and .Values.tls.enabled .Values.tls.existingSecret }}
          - name: tls-certs
            mountPath: {{ .Values.tls.mountPath }}
            readOnly: true
          {{- end }}
          {{- if and (eq ((.Values.oauthSecurity.storage).type | default "memory") "valkey") .Values.oauthSecurity.storage.valkey.tls.enabled .Values.oauthSecurity.storage.valkey.tls.caSecretName }}
          - name: valkey-tls-ca
            mountPath: /etc/valkey-tls
            readOnly: true
          {{- end }}
      volumes:
        {{- with .Values.volumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- if and .Values.tls.enabled .Values.tls.existingSecret }}
        - name: tls-certs
          secret:
            secretName: {{ .Values.tls.existingSecret }}
        {{- end }}
        {{- if and (eq ((.Values.oauthSecurity.storage).type | default "memory") "valkey") .Values.oauthSecurity.storage.valkey.tls.enabled .Values.oauthSecurity.storage.valkey.tls.caSecretName }}
        - name: valkey-tls-ca
          secret:
            secretName: {{ .Values.oauthSecurity.storage.valkey.tls.caSecretName }}
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}


