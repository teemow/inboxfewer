name: Release Helm Chart

on:
  push:
    branches:
      - main
      - feature/issue-oauth-mcp-server-authentication  # For testing
    paths:
      - 'charts/**'
  pull_request:
    branches:
      - main
    paths:
      - 'charts/**'

env:
  REGISTRY: ghcr.io
  CHART_NAME: inboxfewer

jobs:
  release-chart:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin

      - name: Package Helm chart
        run: |
          helm package charts/${{ env.CHART_NAME }} -d .helm-packages

      - name: Push Helm chart to OCI registry
        run: |
          CHART_VERSION=$(helm show chart charts/${{ env.CHART_NAME }} | grep '^version:' | awk '{print $2}')
          
          # For feature branches, append branch name to version
          if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///' | sed 's/\//-/g')
            CHART_VERSION="${CHART_VERSION}-${BRANCH_NAME}-${{ github.sha }}"
            
            # Update version in packaged chart
            helm package charts/${{ env.CHART_NAME }} --version ${CHART_VERSION} -d .helm-packages
          fi
          
          helm push .helm-packages/${{ env.CHART_NAME }}-${CHART_VERSION}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts

      - name: Summary
        run: |
          CHART_VERSION=$(helm show chart charts/${{ env.CHART_NAME }} | grep '^version:' | awk '{print $2}')
          if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///' | sed 's/\//-/g')
            CHART_VERSION="${CHART_VERSION}-${BRANCH_NAME}-${{ github.sha }}"
          fi
          echo "### Helm Chart Released! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Chart: \`${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }}:${CHART_VERSION}\`" >> $GITHUB_STEP_SUMMARY

