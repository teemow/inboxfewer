name: Release Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
  pull_request:
    branches:
      - main
    paths:
      - 'charts/**'
  # Republish chart when a new Docker image is released (new app version)
  workflow_run:
    workflows: ["Build and Push Docker Image (Release)"]
    types:
      - completed
    branches:
      - main

env:
  REGISTRY: ghcr.io
  CHART_NAME: inboxfewer

jobs:
  release-chart:
    runs-on: ubuntu-latest
    # Skip if triggered by workflow_run and the triggering workflow failed
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin

      - name: Determine versions
        id: versions
        run: |
          # Get chart version from Chart.yaml
          CHART_VERSION=$(helm show chart charts/${{ env.CHART_NAME }} | grep '^version:' | awk '{print $2}')
          
          # Get the latest release tag for appVersion using shared script
          APP_VERSION=$(./scripts/get-latest-version.sh)
          
          # For non-main branches, append branch info to chart version
          if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///' | sed 's/\//-/g')
            CHART_VERSION="${CHART_VERSION}-${BRANCH_NAME}-${{ github.sha }}"
            # For PRs/branches, use the commit SHA as appVersion suffix
            APP_VERSION="${APP_VERSION}-${BRANCH_NAME}-${{ github.sha }}"
          fi
          
          echo "chart_version=${CHART_VERSION}" >> "$GITHUB_OUTPUT"
          echo "app_version=${APP_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Chart version: ${CHART_VERSION}"
          echo "App version: ${APP_VERSION}"

      - name: Package Helm chart
        run: |
          # Package with the determined appVersion (dynamically derived from git tags)
          helm package charts/${{ env.CHART_NAME }} \
            --version "${{ steps.versions.outputs.chart_version }}" \
            --app-version "${{ steps.versions.outputs.app_version }}" \
            -d .helm-packages

      - name: Push Helm chart to OCI registry
        run: |
          helm push .helm-packages/${{ env.CHART_NAME }}-${{ steps.versions.outputs.chart_version }}.tgz \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts

      - name: Summary
        run: |
          echo "### Helm Chart Released!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart:** \`${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }}:${{ steps.versions.outputs.chart_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App Version:** \`${{ steps.versions.outputs.app_version }}\`" >> $GITHUB_STEP_SUMMARY

